# ARM64DBI 更新日志

> 记录项目的所有重要更新和修复

---

## [v1.2.0] - 2024-12-10

### 🐛 Bug 修复

#### AES 追踪密文验证失败问题

**问题**：使用 DBI 追踪 AES 加密函数时，密文结果不正确（全为0或与原始结果不一致）

**根本原因**：
1. 被追踪函数调用了外部库函数（memcpy, printf等），导致追踪器尝试翻译外部库代码
2. 回调函数中进行了复杂操作（DBI::disassemble, vector::push_back），影响程序执行状态

**修复**：
- `AESWhitebox::encrypt_block()` 使用内联循环替代 memcpy
- 回调函数只做最简单的操作（计数、记录PC到固定数组）
- 复杂分析移到追踪完成后的后处理阶段

**文档**：[AES_TRACE_DEBUG_REPORT.md](./AES_TRACE_DEBUG_REPORT.md)

#### 条件分支翻译跳转偏移错误

**问题**：条件分支指令（B.cond/CBZ/CBNZ/TBZ/TBNZ）翻译后跳转到错误地址，导致 SIGILL 崩溃

**根本原因**：跳转偏移使用硬编码值，未考虑翻译后代码的实际大小

**修复**：使用预留槽位 + 回填机制，在生成完整代码后计算正确偏移

**文档**：[CONDITIONAL_BRANCH_FIX.md](./CONDITIONAL_BRANCH_FIX.md)

#### 块大小限制处理

**问题**：某些大型基本块超出 BLOCK_SIZE 限制导致溢出

**修复**：添加安全检查，超出限制时进行块拆分处理

### 📝 文档更新

- 新增 `docs/INDEX.md` - 文档索引和导航
- 新增 `docs/AES_TRACE_DEBUG_REPORT.md` - AES追踪问题排查报告
- 新增 `docs/CONDITIONAL_BRANCH_FIX.md` - 条件分支翻译修复详解
- 新增 `docs/CHANGELOG.md` - 版本更新日志

---

## [v1.1.0] - 2024-12-09

### ✨ 新功能

#### AES 白盒 DFA 攻击定位

- 新增 `AESWhitebox` 类 - AES 白盒加密实现
- 新增 `AES_DFA_Demo` 类 - DFA 攻击定位演示
- 支持定位第10轮密钥的使用位置
- 提供完整的 DFA 攻击指南

#### 数据溯源功能 (DataTracer)

- 新增 `DataTracer` 模块 - 追踪数据来源
- 支持监控特定内存区域的读取
- 支持 Trace 文件生成和导出
- 可精确定位密钥读取位置

#### 新增指令支持

| 指令 | 类型 | 描述 |
|------|------|------|
| BLR | 间接调用 | 通过寄存器间接函数调用 |
| CBZ | 条件分支 | 比较寄存器与零，相等则跳转 |
| CBNZ | 条件分支 | 比较寄存器与零，不等则跳转 |
| TBZ | 条件分支 | 测试指定位，为0则跳转 |
| TBNZ | 条件分支 | 测试指定位，为1则跳转 |
| ADR | 地址计算 | PC相对地址计算（小范围） |

### 🔧 污点分析增强

- 修复 LDP/STP 双寄存器污点传播
- 添加 LDUR/STUR 非对齐内存访问支持
- 添加条件选择指令污点传播 (CSEL/CSINC/CSINV/CSNEG)
- 添加字节序反转指令污点传播 (REV/REV16/REV32/REV64/RBIT)
- 添加位域操作指令污点传播 (UBFM/SBFM/BFM/EXTR)
- 添加扩展指令污点传播 (SXTB/SXTH/SXTW/UXTB/UXTH)
- 添加位计数指令污点传播 (CLZ/CLS/CNT)

### 💪 健壮性提升

- Memory 类添加内存池状态检查和诊断方法
- DBI 类添加参数验证和状态检查
- Translator 添加安全限制防止基本块溢出
- 添加 `DBI::dump_status()` 调试方法
- 添加 `DBI::destroy()` 资源清理方法

### 📝 文档更新

- 更新 README.md 添加新功能说明
- 更新 TAINT_ANALYSIS.md 添加 DFA 攻击案例
- 更新 LEARNING_GUIDE.md 添加新指令说明

---

## [v1.0.0] - 初始版本

### ✨ 核心功能

- 基础 DBI 框架实现
- 指令级追踪回调
- 完整 CPU 上下文访问
- 基本块缓存机制

### 📋 支持的指令

| 指令 | 类型 | 描述 |
|------|------|------|
| B | 无条件跳转 | 直接跳转 |
| BL | 函数调用 | 带返回地址的跳转 |
| BR | 间接跳转 | 通过寄存器跳转 |
| RET | 函数返回 | 从 LR 返回 |
| B.cond | 条件跳转 | 条件分支 |
| ADRP | 地址计算 | 页地址计算 |

### 🔬 污点分析

- 寄存器级污点追踪 (X0-X30, SP)
- 内存级污点追踪
- 自动污点传播
- 多标签支持

### 📝 文档

- README.md - 项目概述
- LEARNING_GUIDE.md - 学习指南
- TAINT_ANALYSIS.md - 污点分析指南

---

## 版本号说明

版本号格式: `主版本.次版本.修订版本`

- **主版本** - 不兼容的 API 变更
- **次版本** - 向后兼容的功能新增
- **修订版本** - 向后兼容的问题修复

---

## 贡献者

- **lidongyooo** - 初始开发

---

*最后更新: 2024-12-10*

