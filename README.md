# ARM64DBI - ARM64 åŠ¨æ€äºŒè¿›åˆ¶æ’æ¡©æ¡†æ¶

> ARM64 Dynamic Binary Instrumentation Framework for Android

[![Platform](https://img.shields.io/badge/platform-Android-green.svg)](https://developer.android.com)
[![Architecture](https://img.shields.io/badge/arch-ARM64-blue.svg)](https://developer.arm.com)
[![License](https://img.shields.io/badge/license-MIT-brightgreen.svg)](LICENSE)

## ğŸ“– ç›®å½•

- [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
- [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [æ ¸å¿ƒç»„ä»¶è¯¦è§£](#æ ¸å¿ƒç»„ä»¶è¯¦è§£)
- [å·¥ä½œåŸç†](#å·¥ä½œåŸç†)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [API å‚è€ƒ](#api-å‚è€ƒ)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [æŠ€æœ¯ç»†èŠ‚](#æŠ€æœ¯ç»†èŠ‚)
- [æ„å»ºæŒ‡å—](#æ„å»ºæŒ‡å—)
- [æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)

---

## é¡¹ç›®ç®€ä»‹

ARM64DBI æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ ARM64 åŠ¨æ€äºŒè¿›åˆ¶æ’æ¡©ï¼ˆDynamic Binary Instrumentationï¼‰æ¡†æ¶ï¼Œä¸“ä¸º Android å¹³å°è®¾è®¡ã€‚å®ƒå…è®¸åœ¨è¿è¡Œæ—¶å¯¹ ARM64 äºŒè¿›åˆ¶ä»£ç è¿›è¡Œè¿½è¸ªå’Œåˆ†æï¼Œ**æ— éœ€ä¿®æ”¹æºä»£ç æˆ–é‡æ–°ç¼–è¯‘ç›®æ ‡ç¨‹åº**ã€‚

### ä»€ä¹ˆæ˜¯åŠ¨æ€äºŒè¿›åˆ¶æ’æ¡© (DBI)?

åŠ¨æ€äºŒè¿›åˆ¶æ’æ¡©æ˜¯ä¸€ç§åœ¨ç¨‹åºè¿è¡Œæ—¶åˆ†æå’Œä¿®æ”¹äºŒè¿›åˆ¶ä»£ç çš„æŠ€æœ¯ã€‚ä¸é™æ€åˆ†æä¸åŒï¼ŒDBI å¯ä»¥ï¼š

- å®æ—¶è¿½è¸ªç¨‹åºæ‰§è¡Œæµç¨‹
- åœ¨æ¯æ¡æŒ‡ä»¤æ‰§è¡Œå‰/åæ’å…¥è‡ªå®šä¹‰ä»£ç 
- ç›‘æ§å¯„å­˜å™¨å’Œå†…å­˜çŠ¶æ€
- åˆ†æç¨‹åºè¡Œä¸ºè€Œä¸å½±å“åŸæœ‰åŠŸèƒ½

### å…¸å‹åº”ç”¨åœºæ™¯

| åœºæ™¯ | æè¿° |
|------|------|
| **ç¨‹åºè°ƒè¯•** | è¿½è¸ªå‡½æ•°è°ƒç”¨ã€åˆ†ææ‰§è¡Œè·¯å¾„ |
| **æ€§èƒ½åˆ†æ** | ç»Ÿè®¡æŒ‡ä»¤æ‰§è¡Œæ¬¡æ•°ã€è¯†åˆ«çƒ­ç‚¹ä»£ç  |
| **å®‰å…¨ç ”ç©¶** | æ¼æ´æŒ–æ˜ã€æ¶æ„ä»£ç åˆ†æ |
| **é€†å‘å·¥ç¨‹** | åŠ¨æ€è¿½è¸ªç®—æ³•æµç¨‹ã€æå–åŠ å¯†é€»è¾‘ |
| **ä»£ç è¦†ç›–ç‡** | Fuzzing æµ‹è¯•çš„ä»£ç è¦†ç›–ç‡ç»Ÿè®¡ |

---

## æ ¸å¿ƒç‰¹æ€§

- âœ… **çº¯ ARM64 åŸç”Ÿå®ç°** - æ— éœ€ä¾èµ– QEMU ç­‰æ¨¡æ‹Ÿå™¨
- âœ… **è½»é‡çº§è®¾è®¡** - æ ¸å¿ƒä»£ç ç²¾ç®€ï¼Œæ˜“äºç†è§£å’Œæ‰©å±•
- âœ… **æŒ‡ä»¤çº§è¿½è¸ª** - æ”¯æŒæ¯æ¡æŒ‡ä»¤çš„å›è°ƒé€šçŸ¥
- âœ… **å®Œæ•´ CPU ä¸Šä¸‹æ–‡** - å›è°ƒæ—¶å¯è®¿é—®æ‰€æœ‰é€šç”¨å¯„å­˜å™¨å’ŒçŠ¶æ€æ ‡å¿—
- âœ… **åŸºæœ¬å—ç¼“å­˜** - å·²ç¿»è¯‘çš„ä»£ç å—ä¼šè¢«ç¼“å­˜ï¼Œæé«˜æ‰§è¡Œæ•ˆç‡
- âœ… **é€æ˜æ‰§è¡Œ** - æ’æ¡©åçš„ç¨‹åºåŠŸèƒ½ä¸åŸç¨‹åºå®Œå…¨ä¸€è‡´

---

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·å±‚ (User Layer)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ç›®æ ‡å‡½æ•°         â”‚    â”‚  ç”¨æˆ·å›è°ƒå‡½æ•° (DBICallback)        â”‚  â”‚
â”‚  â”‚  (Target Code)    â”‚    â”‚  - è·å– CPU ä¸Šä¸‹æ–‡                 â”‚  â”‚
â”‚  â”‚                   â”‚    â”‚  - åæ±‡ç¼–å½“å‰æŒ‡ä»¤                  â”‚  â”‚
â”‚  â”‚  quick_sort()     â”‚    â”‚  - è®°å½•/åˆ†ææ‰§è¡Œä¿¡æ¯               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                              â–²                      â”‚
â”‚            â–¼                              â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    DBI å…¥å£ç‚¹                                â”‚â”‚
â”‚  â”‚           DBI::trace(target_addr, callback)                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DBI æ ¸å¿ƒå±‚ (Core Layer)                     â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Translator  â”‚â—„â”€â”€â–ºâ”‚   Router     â”‚â—„â”€â”€â–ºâ”‚     Memory       â”‚   â”‚
â”‚  â”‚  (ç¿»è¯‘å™¨)     â”‚    â”‚  (è·¯ç”±å™¨)     â”‚    â”‚   (å†…å­˜ç®¡ç†)      â”‚   â”‚
â”‚  â”‚              â”‚    â”‚              â”‚    â”‚                  â”‚   â”‚
â”‚  â”‚ - æ‰«æåŸºæœ¬å—  â”‚    â”‚ - æ§åˆ¶æµè½¬ç§»  â”‚    â”‚ - ä»£ç å—åˆ†é…      â”‚   â”‚
â”‚  â”‚ - ç¿»è¯‘æŒ‡ä»¤    â”‚    â”‚ - å¯„å­˜å™¨ä¿å­˜  â”‚    â”‚ - ç¼“å­˜ç®¡ç†        â”‚   â”‚
â”‚  â”‚ - æ’å…¥å›è°ƒ    â”‚    â”‚ - åœ°å€è·¯ç”±    â”‚    â”‚ - mmap å†…å­˜æ±      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                     Assembler (æ±‡ç¼–å™¨)                       â”‚â”‚
â”‚  â”‚                                                              â”‚â”‚
â”‚  â”‚   ç”Ÿæˆ ARM64 æœºå™¨ç : movz, movk, str, blr, br, ret, b ...   â”‚â”‚
â”‚  â”‚   prolog/epilog: ä¿å­˜/æ¢å¤ CPU ä¸Šä¸‹æ–‡                        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¾èµ–å±‚ (Dependencies)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                   Capstone åæ±‡ç¼–å¼•æ“                        â”‚â”‚
â”‚  â”‚           ç”¨äºåæ±‡ç¼– ARM64 æŒ‡ä»¤ï¼Œè§£ææ“ä½œæ•°                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. DBI ç±» (`DBI.cpp/h`) - æ ¸å¿ƒæ§åˆ¶å™¨

**èŒè´£**ï¼šä½œä¸ºæ•´ä¸ªæ¡†æ¶çš„å…¥å£ç‚¹ï¼Œç®¡ç†åæ±‡ç¼–å¼•æ“å’Œç”¨æˆ·å›è°ƒã€‚

```cpp
class DBI {
    // å•ä¾‹æ¨¡å¼
    static DBI* getInstance();
    
    // æ ¸å¿ƒå…¥å£ï¼šå¼€å§‹è¿½è¸ªç›®æ ‡å‡½æ•°
    static void* trace(uint64_t target_addr, DBICallback callback);
    
    // åæ±‡ç¼–æŒ‡å®šåœ°å€çš„æŒ‡ä»¤
    static cs_insn* disassemble(uint64_t pc);
    
    // è·å–ç”¨æˆ·å›è°ƒå‡½æ•°æŒ‡é’ˆ
    static DBICallback get_dbi_callback();
};
```

**CPU ä¸Šä¸‹æ–‡ç»“æ„**ï¼š

```cpp
typedef struct CPU_CONTEXT {
    uint64_t fp;      // æ ˆåº• (X29)
    uint64_t lr;      // é“¾æ¥å¯„å­˜å™¨ (X30)
    int64_t x[29];    // X0-X28 é€šç”¨å¯„å­˜å™¨
    uint64_t sp;      // æ ˆé¡¶
    uint64_t pc;      // ç¨‹åºè®¡æ•°å™¨
    uint64_t nzcv;    // æ¡ä»¶æ ‡å¿—ä½
} CPU_CONTEXT;
```

---

### 2. Translator ç±» (`Translator.cpp/h`) - ç¿»è¯‘å™¨

**èŒè´£**ï¼šæ‰«æåŸå§‹ä»£ç åŸºæœ¬å—ï¼Œå°†å…¶ç¿»è¯‘ä¸ºæ’æ¡©åçš„ä»£ç ã€‚

```cpp
class Translator {
    // æ‰«æå¹¶ç¿»è¯‘åŸºæœ¬å—
    static void scan(uint64_t target_addr, BlockMeta* block_meta, ROUTER_TYPE type);
    
    // å„ç±»æŒ‡ä»¤çš„ç¿»è¯‘å¤„ç†
    static void b_ins_handle(uint32_t*& writer, uint64_t pc);      // B æŒ‡ä»¤
    static void bl_ins_handle(uint32_t*& writer, uint64_t pc);     // BL æŒ‡ä»¤
    static void br_ins_handle(uint32_t*& writer, uint64_t pc);     // BR æŒ‡ä»¤
    static void b_cond_ins_handle(uint32_t*& writer, uint64_t pc); // B.cond æ¡ä»¶è·³è½¬
    static void adrp_ins_handle(uint32_t*& writer, uint64_t pc);   // ADRP åœ°å€è®¡ç®—
    static void ret_ins_handle(uint32_t*& writer, uint64_t pc);    // RET è¿”å›
    static void default_ins_handle(uint32_t*& writer, uint64_t pc); // æ™®é€šæŒ‡ä»¤
    
    // æ’å…¥å›è°ƒä»£ç 
    static void callback(uint32_t*& writer, uint64_t pc);
};
```

**ç¿»è¯‘æµç¨‹**ï¼š

```
åŸå§‹æŒ‡ä»¤                        ç¿»è¯‘åçš„ä»£ç 
â”€â”€â”€â”€â”€â”€â”€â”€                        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                               â”Œâ”€ prolog (ä¿å­˜å¯„å­˜å™¨)
                               â”‚  å†™å…¥å½“å‰ PC åˆ°ä¸Šä¸‹æ–‡
ADD X0, X1, X2   â”€â”€ç¿»è¯‘â”€â”€â–º    â”‚  è°ƒç”¨ç”¨æˆ·å›è°ƒ
                               â”‚  epilog (æ¢å¤å¯„å­˜å™¨)
                               â””â”€ ADD X0, X1, X2 (åŸæŒ‡ä»¤)
```

---

### 3. Assembler ç±» (`Assembler.cpp/h/S`) - æ±‡ç¼–å™¨

**èŒè´£**ï¼šç”Ÿæˆ ARM64 æœºå™¨ç ï¼Œå¤„ç†å¯„å­˜å™¨ä¿å­˜/æ¢å¤ã€‚

**æ±‡ç¼–ä»£ç æ¨¡æ¿** (`Assembler.S`)ï¼š

```asm
; prolog - ä¿å­˜ CPU ä¸Šä¸‹æ–‡ (272 å­—èŠ‚)
start_prolog:
    STP X29, X30, [SP, #-CPU_CONTEXT_SIZE]!  ; ä¿å­˜ FP, LR
    ADD X29, SP, #CPU_CONTEXT_SIZE
    STP X0, X1, [SP, #16]                     ; ä¿å­˜ X0-X28
    STP X2, X3, [SP, #32]
    ...
    MRS X0, nzcv                              ; ä¿å­˜æ ‡å¿—ä½
    STR X0, [SP, #264]
end_prolog:

; epilog - æ¢å¤ CPU ä¸Šä¸‹æ–‡
start_epilog:
    LDR X0, [SP, #264]                        ; æ¢å¤æ ‡å¿—ä½
    MSR nzcv, X0
    ...
    LDP X29, X30, [SP], #CPU_CONTEXT_SIZE     ; æ¢å¤ FP, LR
end_epilog:
```

**ä¸»è¦å‡½æ•°**ï¼š

| å‡½æ•° | åŠŸèƒ½ |
|------|------|
| `movz()` | ç”Ÿæˆ MOVZ æŒ‡ä»¤ï¼ˆåŠ è½½ç«‹å³æ•°ä½16ä½ï¼‰ |
| `movk()` | ç”Ÿæˆ MOVK æŒ‡ä»¤ï¼ˆä¿æŒå¹¶åŠ è½½16ä½ï¼‰ |
| `write_value_to_reg()` | å°†64ä½å€¼å†™å…¥å¯„å­˜å™¨ï¼ˆè‡ªåŠ¨ä¼˜åŒ–æŒ‡ä»¤æ•°ï¼‰ |
| `br_x16_jump()` | ç”Ÿæˆé—´æ¥è·³è½¬åˆ°ç›®æ ‡åœ°å€ |
| `blr_x16_jump()` | ç”Ÿæˆé—´æ¥è°ƒç”¨åˆ°ç›®æ ‡åœ°å€ |
| `get_b_addr()` | è§£æ B æŒ‡ä»¤çš„è·³è½¬ç›®æ ‡åœ°å€ |
| `get_bl_addr()` | è§£æ BL æŒ‡ä»¤çš„è°ƒç”¨ç›®æ ‡åœ°å€ |
| `get_adrp_addr()` | è®¡ç®— ADRP æŒ‡ä»¤çš„ç›®æ ‡åœ°å€ |

---

### 4. Router ç±» (`Router.cpp/h/S`) - è·¯ç”±å™¨

**èŒè´£**ï¼šç®¡ç†æ§åˆ¶æµè½¬ç§»ï¼Œå¤„ç†è·³è½¬æŒ‡ä»¤çš„è·¯ç”±é€»è¾‘ã€‚

**æ ¸å¿ƒæ±‡ç¼–ä»£ç ** (`Router.S`)ï¼š

```asm
; ä¿å­˜è°ƒç”¨è€…å¯„å­˜å™¨
router_push_register:
    STP X29, X30, [SP, #-176]!
    STP X0, X1, [SP, #16]
    ...
    MRS X0, nzcv              ; ä¿å­˜æ ‡å¿—ä½
    STP X18, X0, [SP, #160]
router_end_push_register:

; æ¢å¤è°ƒç”¨è€…å¯„å­˜å™¨
router_pop_register:
    LDP X18, X0, [SP, #160]
    MSR nzcv, X0              ; æ¢å¤æ ‡å¿—ä½
    ...
    LDP X29, X30, [SP], #176
router_end_pop_register:

; è·¯ç”±å…¥å£
router:
    BL _router                ; è°ƒç”¨ C++ è·¯ç”±å‡½æ•°
    BR X0                     ; è·³è½¬åˆ°ç¿»è¯‘åçš„ä»£ç å—
```

**C++ è·¯ç”±é€»è¾‘**ï¼š

```cpp
uint64_t _router(uint64_t jump_addr, ROUTER_TYPE type) {
    // 1. æ£€æŸ¥ç¼“å­˜ï¼šæ˜¯å¦å·²ç¿»è¯‘è¿‡è¯¥åœ°å€
    auto block_meta = Memory::get_cache_block_meta(jump_addr);
    
    if (block_meta == nullptr) {
        // 2. æœªç¿»è¯‘ï¼šåˆ†é…æ–°å—å¹¶ç¿»è¯‘
        block_meta = Memory::get_or_new_block_meta();
        Translator::scan(jump_addr, block_meta, type);
    }
    
    // 3. è¿”å›ç¿»è¯‘åä»£ç çš„èµ·å§‹åœ°å€
    return (uint64_t)block_meta->block_start;
}
```

**è·¯ç”±ç±»å‹**ï¼š

```cpp
enum ROUTER_TYPE {
    ENDING_ROUTER_TYPE,  // ç»“æŸç±»å‹ï¼ˆä» trace å…¥å£è¿›å…¥ï¼‰
    B_ROUTER_TYPE,       // B æŒ‡ä»¤è·³è½¬
    BL_ROUTER_TYPE,      // BL å‡½æ•°è°ƒç”¨
    BR_ROUTER_TYPE,      // BR é—´æ¥è·³è½¬
    BLR_ROUTER_TYPE,     // BLR é—´æ¥è°ƒç”¨
    RET_ROUTER_TYPE      // RET å‡½æ•°è¿”å›
};
```

---

### 5. Memory ç±» (`Memory.cpp/h`) - å†…å­˜ç®¡ç†

**èŒè´£**ï¼šç®¡ç†æ’æ¡©ä»£ç çš„å†…å­˜åˆ†é…å’Œç¼“å­˜ã€‚

```cpp
#define BLOCK_NUMBER 4096   // æœ€å¤§åŸºæœ¬å—æ•°é‡
#define BLOCK_SIZE 1024     // æ¯ä¸ªå—çš„æŒ‡ä»¤å®¹é‡

struct BlockMeta {
    int index;                    // å—ç´¢å¼•
    void* code_start;             // åŸå§‹ä»£ç èµ·å§‹åœ°å€
    int code_size;                // åŸå§‹ä»£ç å¤§å°
    void* block_start;            // ç¿»è¯‘åä»£ç èµ·å§‹åœ°å€
    int block_size;               // ç¿»è¯‘åä»£ç å¤§å°
    BlockMeta* slice_block_meta;  // å¤§å—æ‹†åˆ†æ—¶çš„é“¾è¡¨
    uint32_t code[BLOCK_SIZE];    // ç¿»è¯‘åçš„æœºå™¨ç å­˜å‚¨
};

class Memory {
    // é¢„åˆ†é…å†…å­˜æ± ï¼ˆmmap åˆ†é…ï¼Œå…·æœ‰æ‰§è¡Œæƒé™ï¼‰
    BlockMeta* first_block_meta;
    
    // åœ°å€åˆ°å—ç´¢å¼•çš„æ˜ å°„ï¼ˆç”¨äºç¼“å­˜æŸ¥æ‰¾ï¼‰
    std::unordered_map<uint64_t, int> cache_block_meta;
    
    // è·å–æˆ–åˆ›å»ºåŸºæœ¬å—
    static BlockMeta* get_or_new_block_meta(int index = 99999999);
    
    // ç¼“å­˜æ“ä½œ
    static bool set_cache_block_meta(uint64_t key, int value);
    static BlockMeta* get_cache_block_meta(uint64_t key);
};
```

**å†…å­˜å¸ƒå±€**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   é¢„åˆ†é…å†…å­˜æ±  (mmap)                       â”‚
â”‚                   æƒé™: RWX (è¯»å†™æ‰§è¡Œ)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  BlockMeta 0 â”‚  BlockMeta 1 â”‚  BlockMeta 2 â”‚     ...      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚
â”‚  â”‚ header  â”‚ â”‚  â”‚ header  â”‚ â”‚  â”‚ header  â”‚ â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚              â”‚
â”‚  â”‚  code   â”‚ â”‚  â”‚  code   â”‚ â”‚  â”‚  code   â”‚ â”‚              â”‚
â”‚  â”‚ [1024]  â”‚ â”‚  â”‚ [1024]  â”‚ â”‚  â”‚ [1024]  â”‚ â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 6. Utils ç±» (`Utils.cpp/h`) - å·¥å…·ç±»

**èŒè´£**ï¼šæä¾›è°ƒè¯•å’Œè¾…åŠ©åŠŸèƒ½ã€‚

```cpp
class Utils {
    // åæ±‡ç¼–å¹¶æ‰“å°ä»£ç 
    static void show_code(void* code_addr, int number = 999);
    
    // æ‰“å°ç¿»è¯‘åçš„åŸºæœ¬å—
    static void show_block_code(BlockMeta* block_meta);
};
```

---

## å·¥ä½œåŸç†

### æ•´ä½“æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç”¨æˆ·è°ƒç”¨ DBI::trace(quick_sort, my_callback)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. åˆ†é… BlockMetaï¼Œè°ƒç”¨ Translator::scan() ç¿»è¯‘ç¬¬ä¸€ä¸ªåŸºæœ¬å—      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Translator éå†åŸå§‹æŒ‡ä»¤ï¼š                                    â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚  å¯¹äºæ¯æ¡æŒ‡ä»¤ï¼š                                         â”‚   â”‚
â”‚     â”‚    a. ç”Ÿæˆ prolog (ä¿å­˜å¯„å­˜å™¨)                          â”‚   â”‚
â”‚     â”‚    b. å†™å…¥å½“å‰ PC åˆ° CPU_CONTEXT                        â”‚   â”‚
â”‚     â”‚    c. è°ƒç”¨ç”¨æˆ·å›è°ƒå‡½æ•°                                   â”‚   â”‚
â”‚     â”‚    d. ç”Ÿæˆ epilog (æ¢å¤å¯„å­˜å™¨)                          â”‚   â”‚
â”‚     â”‚    e. å¤„ç†æŒ‡ä»¤ï¼š                                        â”‚   â”‚
â”‚     â”‚       - æ™®é€šæŒ‡ä»¤: ç›´æ¥å¤åˆ¶                              â”‚   â”‚
â”‚     â”‚       - PCç›¸å…³æŒ‡ä»¤(ADRP): é‡æ–°è®¡ç®—åœ°å€                  â”‚   â”‚
â”‚     â”‚       - è·³è½¬æŒ‡ä»¤(B/BL/BR/RET): è·³è½¬åˆ° Router            â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. è¿”å›ç¿»è¯‘åä»£ç çš„èµ·å§‹åœ°å€ï¼Œç”¨æˆ·ç›´æ¥è°ƒç”¨æ‰§è¡Œ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°è·³è½¬æŒ‡ä»¤æ—¶ï¼š                                    â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚  Router æ¥ç®¡æ§åˆ¶æµï¼š                                    â”‚   â”‚
â”‚     â”‚    a. ä¿å­˜å¯„å­˜å™¨çŠ¶æ€                                    â”‚   â”‚
â”‚     â”‚    b. æŸ¥æ‰¾ç›®æ ‡åœ°å€æ˜¯å¦å·²ç¿»è¯‘ï¼ˆç¼“å­˜æŸ¥æ‰¾ï¼‰                  â”‚   â”‚
â”‚     â”‚    c. æœªæ‰¾åˆ°åˆ™ç¿»è¯‘æ–°çš„åŸºæœ¬å—                            â”‚   â”‚
â”‚     â”‚    d. æ¢å¤å¯„å­˜å™¨çŠ¶æ€                                    â”‚   â”‚
â”‚     â”‚    e. è·³è½¬åˆ°ç¿»è¯‘åçš„ä»£ç ç»§ç»­æ‰§è¡Œ                         â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. é‡åˆ° RET ä¸”è¿”å›åœ°å€ä¸ºåˆå§‹ LR æ—¶ï¼Œç»“æŸè¿½è¸ªï¼Œè¿”å›åŸè°ƒç”¨è€…       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŒ‡ä»¤ç¿»è¯‘ç¤ºä¾‹

**åŸå§‹ B æŒ‡ä»¤ç¿»è¯‘**ï¼š

```
åŸå§‹ä»£ç :                      ç¿»è¯‘åä»£ç :
                              
                              ; === å›è°ƒéƒ¨åˆ† ===
                              prolog                    ; ä¿å­˜ X0-X28, FP, LR, NZCV
                              MOV X0, #pc               ; å†™å…¥å½“å‰ PC
                              STR X0, [SP, #256]        ; å­˜å…¥ CPU_CONTEXT.pc
                              MOV X0, SP                ; å‚æ•°: CPU_CONTEXT*
B target    â”€â”€ç¿»è¯‘â”€â”€â–º         BLR X16                   ; è°ƒç”¨ç”¨æˆ·å›è°ƒ
                              epilog                    ; æ¢å¤æ‰€æœ‰å¯„å­˜å™¨
                              
                              ; === è·³è½¬éƒ¨åˆ† ===
                              push_register             ; Router ä¿å­˜å¯„å­˜å™¨
                              MOV X1, #B_ROUTER_TYPE    ; è·¯ç”±ç±»å‹
                              MOV X0, #target           ; è·³è½¬ç›®æ ‡åœ°å€
                              MOV X16, #router          ; Router åœ°å€
                              BR X16                    ; è·³è½¬åˆ° Router
```

**åŸå§‹ ADRP æŒ‡ä»¤ç¿»è¯‘**ï¼š

```
åŸå§‹ä»£ç :                      ç¿»è¯‘åä»£ç :
                              
ADRP X0, #page  â”€â”€ç¿»è¯‘â”€â”€â–º     ; === å›è°ƒéƒ¨åˆ† ===
                              prolog
                              ... (è°ƒç”¨å›è°ƒ)
                              epilog
                              
                              ; === åœ°å€è®¡ç®— ===
                              ; ç›´æ¥è®¡ç®—å‡ºç»å¯¹åœ°å€ï¼Œé¿å… PC ç›¸å¯¹é—®é¢˜
                              MOVZ X0, #addr[0:15]
                              MOVK X0, #addr[16:31], LSL #16
                              MOVK X0, #addr[32:47], LSL #32
                              MOVK X0, #addr[48:63], LSL #48
```

---

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚

- Android Studio Arctic Fox æˆ–æ›´é«˜ç‰ˆæœ¬
- Android NDK r21 æˆ–æ›´é«˜ç‰ˆæœ¬
- æ”¯æŒ ARM64 çš„ Android è®¾å¤‡æˆ–æ¨¡æ‹Ÿå™¨
- æœ€ä½ Android API 24 (Android 7.0)

### 2. å…‹éš†é¡¹ç›®

```bash
git clone https://github.com/lidongyooo/ARM64DBI.git
cd ARM64DBI
```

### 3. æ„å»ºè¿è¡Œ

```bash
# ä½¿ç”¨ Android Studio æ‰“å¼€é¡¹ç›®
# æˆ–å‘½ä»¤è¡Œæ„å»º
./gradlew assembleDebug

# å®‰è£…åˆ°è®¾å¤‡
adb install app/build/outputs/apk/debug/app-debug.apk
```

---

## API å‚è€ƒ

### DBI::trace

```cpp
void* DBI::trace(uint64_t target_addr, DBICallback callback);
```

**å‚æ•°**ï¼š
- `target_addr`: è¦è¿½è¸ªçš„å‡½æ•°èµ·å§‹åœ°å€
- `callback`: æ¯æ¡æŒ‡ä»¤æ‰§è¡Œå‰è°ƒç”¨çš„å›è°ƒå‡½æ•°

**è¿”å›å€¼**ï¼š
- ç¿»è¯‘åä»£ç çš„å…¥å£åœ°å€ï¼Œå¯å¼ºè½¬ä¸ºå‡½æ•°æŒ‡é’ˆè°ƒç”¨

---

### DBICallback

```cpp
typedef void (*DBICallback)(const CPU_CONTEXT* cpu_context);
```

**å‚æ•°**ï¼š
- `cpu_context`: æŒ‡å‘å½“å‰ CPU ä¸Šä¸‹æ–‡çš„æŒ‡é’ˆ

**CPU_CONTEXT æˆå‘˜**ï¼š

| æˆå‘˜ | ç±»å‹ | æè¿° |
|------|------|------|
| `fp` | `uint64_t` | æ ˆå¸§æŒ‡é’ˆ (X29) |
| `lr` | `uint64_t` | é“¾æ¥å¯„å­˜å™¨ (X30) |
| `x[29]` | `int64_t[]` | é€šç”¨å¯„å­˜å™¨ X0-X28 |
| `sp` | `uint64_t` | æ ˆæŒ‡é’ˆ |
| `pc` | `uint64_t` | å½“å‰æŒ‡ä»¤åœ°å€ |
| `nzcv` | `uint64_t` | æ¡ä»¶æ ‡å¿—ä½ |

---

### DBI::disassemble

```cpp
cs_insn* DBI::disassemble(uint64_t pc);
```

**å‚æ•°**ï¼š
- `pc`: è¦åæ±‡ç¼–çš„æŒ‡ä»¤åœ°å€

**è¿”å›å€¼**ï¼š
- Capstone åæ±‡ç¼–ç»“æœç»“æ„ä½“æŒ‡é’ˆ

---

## ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç¤ºä¾‹ï¼šè¿½è¸ªå¿«é€Ÿæ’åº

```cpp
#include "dbi/DBI.h"

// è¦è¿½è¸ªçš„ç›®æ ‡å‡½æ•°
void quick_sort(int arr[], int left, int right) {
    if (left >= right) return;
    int i = left, j = right;
    int pivot = arr[left];
    while (i < j) {
        while (i < j && arr[j] >= pivot) j--;
        if (i < j) arr[i++] = arr[j];
        while (i < j && arr[i] <= pivot) i++;
        if (i < j) arr[j--] = arr[i];
    }
    arr[i] = pivot;
    quick_sort(arr, left, i - 1);
    quick_sort(arr, i + 1, right);
}

// DBI å›è°ƒå‡½æ•°
void dbi_callback(const CPU_CONTEXT* ctx) {
    // åæ±‡ç¼–å½“å‰æŒ‡ä»¤
    auto insn = DBI::disassemble(ctx->pc);
    
    // æ‰“å°æŒ‡ä»¤å’Œå¯„å­˜å™¨çŠ¶æ€
    LOGE("0x%llx: %s %s", ctx->pc, insn->mnemonic, insn->op_str);
    LOGE("  X0=0x%llx, X1=0x%llx, X2=0x%llx", ctx->x[0], ctx->x[1], ctx->x[2]);
}

// ä½¿ç”¨ DBI è¿½è¸ª
void test_dbi() {
    int arr[] = {9, 3, 5, 8, 10, 1, 2, 6, 4};
    int n = sizeof(arr) / sizeof(arr[0]);
    
    // å¼€å§‹è¿½è¸ªï¼Œè·å–ç¿»è¯‘åçš„å‡½æ•°æŒ‡é’ˆ
    auto dbi_quick_sort = (void(*)(int[], int, int))
        DBI::trace((uint64_t)quick_sort, dbi_callback);
    
    // è°ƒç”¨ç¿»è¯‘åçš„å‡½æ•°ï¼ˆåŠŸèƒ½ä¸åŸå‡½æ•°å®Œå…¨ç›¸åŒï¼‰
    dbi_quick_sort(arr, 0, n - 1);
    
    // è¾“å‡ºæ’åºç»“æœ
    for (int i = 0; i < n; i++) {
        LOGE("arr[%d] = %d", i, arr[i]);
    }
}
```

### é«˜çº§ç¤ºä¾‹ï¼šæå–ç‰¹å®šå¯„å­˜å™¨å€¼

```cpp
// è¾…åŠ©å‡½æ•°ï¼šä» CPU ä¸Šä¸‹æ–‡è·å–å¯„å­˜å™¨å€¼
bool get_register_value(aarch64_reg reg, const CPU_CONTEXT* ctx, uint64_t& out) {
    if (reg >= AARCH64_REG_W0 && reg <= AARCH64_REG_W30) {
        int idx = reg - AARCH64_REG_W0;
        out = ctx->x[idx] & 0xFFFFFFFF;  // W å¯„å­˜å™¨æ˜¯ 32 ä½
    } else if (reg >= AARCH64_REG_X0 && reg <= AARCH64_REG_X28) {
        int idx = reg - AARCH64_REG_X0;
        out = ctx->x[idx];
    } else {
        switch (reg) {
            case AARCH64_REG_SP: out = ctx->sp; break;
            case AARCH64_REG_FP: out = ctx->fp; break;
            case AARCH64_REG_LR: out = ctx->lr; break;
            default: return false;
        }
    }
    return true;
}

// å›è°ƒï¼šæ‰“å°æ¯æ¡æŒ‡ä»¤ä½¿ç”¨çš„æ‰€æœ‰å¯„å­˜å™¨å€¼
void detailed_callback(const CPU_CONTEXT* ctx) {
    auto insn = DBI::disassemble(ctx->pc);
    char reg_info[1024] = {};
    char* ptr = reg_info;
    
    // éå†æŒ‡ä»¤çš„æ‰€æœ‰æ“ä½œæ•°
    for (int i = 0; i < insn->detail->aarch64.op_count; i++) {
        auto op = insn->detail->aarch64.operands[i];
        
        if (op.type == AARCH64_OP_REG || op.type == AARCH64_OP_MEM_REG) {
            const char* name = cs_reg_name(DBI::get_cs_handle(), op.reg);
            uint64_t value;
            if (get_register_value(op.reg, ctx, value)) {
                ptr += snprintf(ptr, sizeof(reg_info) - (ptr - reg_info),
                               "%s=0x%llx ", name, value);
            }
        }
    }
    
    LOGE("0x%llx: %s %s ; %s", ctx->pc, insn->mnemonic, insn->op_str, reg_info);
}
```

### ç¤ºä¾‹è¾“å‡º

```
0x7b8f001234: stp x29, x30, [sp, #-0x40]! ; x29=0x7fff0000 x30=0x7b8f002000 sp=0x7fff0040
0x7b8f001238: mov x29, sp ; x29=0x7fff0000 sp=0x7fff0000
0x7b8f00123c: str x19, [sp, #0x10] ; x19=0x0 sp=0x7fff0000
0x7b8f001240: cmp w1, w2 ; w1=0x0 w2=0x8
0x7b8f001244: b.ge #0x7b8f001280 ; 
0x7b8f001248: mov w8, w1 ; w8=0x0 w1=0x0
...
```

---

## æŠ€æœ¯ç»†èŠ‚

### æ”¯æŒçš„æŒ‡ä»¤ç±»å‹

| æŒ‡ä»¤ç±»å‹ | å¤„ç†æ–¹å¼ | è¯´æ˜ |
|----------|----------|------|
| æ™®é€šç®—æœ¯/é€»è¾‘ | ç›´æ¥å¤åˆ¶ | ADD, SUB, AND, ORR ç­‰ |
| å†…å­˜è®¿é—® | ç›´æ¥å¤åˆ¶ | LDR, STR, LDP, STP ç­‰ |
| B (æ— æ¡ä»¶è·³è½¬) | ç¿»è¯‘ + Router | è®¡ç®—ç›®æ ‡åœ°å€ï¼Œè·³è½¬åˆ° Router |
| B.cond (æ¡ä»¶è·³è½¬) | ç¿»è¯‘ + Router | ä¿æŒæ¡ä»¶ï¼Œè°ƒæ•´è·³è½¬ç›®æ ‡ |
| BL (å‡½æ•°è°ƒç”¨) | ç¿»è¯‘ + Router | è®¾ç½® LR åè·³è½¬åˆ° Router |
| BR (é—´æ¥è·³è½¬) | ç¿»è¯‘ + Router | ä»å¯„å­˜å™¨è·å–ç›®æ ‡åœ°å€ |
| RET (è¿”å›) | ç¿»è¯‘ + Router | ä» LR è·å–è¿”å›åœ°å€ |
| ADRP (åœ°å€è®¡ç®—) | é‡æ–°è®¡ç®— | å°† PC ç›¸å¯¹åœ°å€è½¬ä¸ºç»å¯¹åœ°å€ |

### PC ç›¸å…³æŒ‡ä»¤å¤„ç†

ARM64 ä¸­æŸäº›æŒ‡ä»¤ä¾èµ– PCï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰çš„å€¼ï¼š

1. **ADRP** - è®¡ç®— 4KB å¯¹é½çš„é¡µåœ°å€
   - åŸç†ï¼š`target = (PC & ~0xFFF) + (imm << 12)`
   - å¤„ç†ï¼šé¢„å…ˆè®¡ç®—ç»å¯¹åœ°å€ï¼Œä½¿ç”¨ MOV æŒ‡ä»¤åºåˆ—åŠ è½½

2. **B/BL** - PC ç›¸å¯¹è·³è½¬
   - åŸç†ï¼š`target = PC + (imm << 2)`
   - å¤„ç†ï¼šè§£æè·³è½¬ç›®æ ‡ï¼Œè·³è½¬åˆ° Router è¿›è¡Œè·¯ç”±

### åŸºæœ¬å—è¾¹ç•Œè¯†åˆ«

ç¿»è¯‘å™¨é€šè¿‡ä»¥ä¸‹æŒ‡ä»¤è¯†åˆ«åŸºæœ¬å—è¾¹ç•Œï¼š
- `B` (æ— æ¡ä»¶è·³è½¬)
- `BL` (å‡½æ•°è°ƒç”¨)
- `BR` (é—´æ¥è·³è½¬)
- `RET` (å‡½æ•°è¿”å›)

é‡åˆ°è¿™äº›æŒ‡ä»¤æ—¶ï¼Œå½“å‰åŸºæœ¬å—ç¿»è¯‘ç»“æŸï¼Œæ§åˆ¶æƒè½¬ç§»ç»™ Routerã€‚

---

## æ„å»ºæŒ‡å—

### CMake é…ç½®

```cmake
cmake_minimum_required(VERSION 3.22.1)
project("arm64dbidemo")

# æºæ–‡ä»¶
file(GLOB SRC_FILES
    "${CMAKE_CURRENT_SOURCE_DIR}/dbi/*.cpp"
    "${CMAKE_CURRENT_SOURCE_DIR}/*.cpp"
)

# æ±‡ç¼–æ–‡ä»¶
file(GLOB ASM_FILES
    "${CMAKE_CURRENT_SOURCE_DIR}/dbi/*.S"
)

# ç¼–è¯‘é€‰é¡¹
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -O2")
enable_language(ASM)

# é“¾æ¥åº“
target_link_libraries(${CMAKE_PROJECT_NAME}
    android
    log
    ${LIBS_PATH}/libcapstone.a
)
```

### ä¾èµ–è¯´æ˜

| ä¾èµ– | ç”¨é€” |
|------|------|
| Capstone | ARM64 åæ±‡ç¼–å¼•æ“ |
| Android Log | æ—¥å¿—è¾“å‡º |

---

## æ³¨æ„äº‹é¡¹

### é™åˆ¶

1. **ä»…æ”¯æŒ ARM64** - ä¸æ”¯æŒ ARM32 æˆ–å…¶ä»–æ¶æ„
2. **ä¸æ”¯æŒè‡ªä¿®æ”¹ä»£ç ** - å‡è®¾ä»£ç åœ¨æ‰§è¡ŒæœŸé—´ä¸å˜
3. **æµ®ç‚¹å¯„å­˜å™¨** - å½“å‰ç‰ˆæœ¬ä¸ä¿å­˜/æ¢å¤ SIMD/FP å¯„å­˜å™¨
4. **ä¿¡å·å¤„ç†** - ä¸æ”¯æŒä¿¡å·å¤„ç†ç¨‹åºä¸­çš„ä»£ç è¿½è¸ª
5. **å¤šçº¿ç¨‹** - åŸºæœ¬å—ç¼“å­˜éçº¿ç¨‹å®‰å…¨

### æ€§èƒ½å½±å“

ç”±äºæ¯æ¡æŒ‡ä»¤éƒ½ä¼šè§¦å‘å›è°ƒï¼Œå¼€å¯ DBI åç¨‹åºè¿è¡Œé€Ÿåº¦ä¼šæ˜¾è‘—é™ä½ã€‚å»ºè®®ï¼š

- ä»…è¿½è¸ªæ„Ÿå…´è¶£çš„å…³é”®å‡½æ•°
- å›è°ƒå‡½æ•°ä¸­é¿å…å¤æ‚æ“ä½œ
- åˆ©ç”¨åŸºæœ¬å—ç¼“å­˜å‡å°‘ç¿»è¯‘å¼€é”€

### å®‰å…¨è€ƒè™‘

- ç¿»è¯‘åçš„ä»£ç å­˜å‚¨åœ¨ RWX å†…å­˜ä¸­
- ç”Ÿäº§ç¯å¢ƒä¸­åº”è€ƒè™‘å®‰å…¨åŠ å›ºæªæ–½
- é¿å…è¿½è¸ªä¸å—ä¿¡ä»»çš„ä»£ç 

---

## å‚è€ƒèµ„æ–™

- [ARM64 åŠ¨æ€äºŒè¿›åˆ¶æ’æ¡©çš„åŸç†ä¸å®ç°](https://mp.weixin.qq.com/s/FxzUCAcYwzLDvbxntA7aow) - ä½œè€…åŸæ–‡
- [ARM Architecture Reference Manual](https://developer.arm.com/documentation/ddi0487/latest) - ARM64 å®˜æ–¹æ‰‹å†Œ
- [Capstone Disassembly Framework](https://www.capstone-engine.org/) - åæ±‡ç¼–å¼•æ“

---

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚

## ä½œè€…

- **lidongyooo** - åˆå§‹å¼€å‘

---

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼
